<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AddStory.js Flowchart</title>
    <style>
        @page {
            size: A4;
            margin: 10mm;
        }

        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background-color: white;
        }

        .mermaid {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Ensure the SVG generated by mermaid scales to fit */
        .mermaid svg {
            max-width: 100vw;
            max-height: 100vh;
            height: auto !important;
            width: auto !important;
        }
    </style>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>
</head>

<body>
    <div class="mermaid">
        flowchart TD
        Start([Start / Load Script]) --> Init[Initialize Dependencies & Config]
        Init --> Listeners[Setup Event Listeners]
        Listeners --> WaitForInput{Event Triggered?}

        %% Receive Slug (Entry Point)
        WaitForInput -->|ipcRenderer 'receiveSlug'| CheckSlug[Check Slug]
        CheckSlug -->|Slug is Empty| ModeAdd[Set Mode: 'Add Story']
        CheckSlug -->|Slug Exists| ModeEdit[Set Mode: 'Update Story']
        ModeEdit --> LoadData[ReadSlug: Fetch Story JSON]
        LoadData --> PopulateForm[Populate Fields & Full Story Editor]
        ModeAdd & PopulateForm --> WaitUser[Wait for User Interaction]

        %% User Interaction: Add Content Block
        WaitUser -->|Click .btnAdd| AddField[AddField: Add Editor Block]
        AddField --> WaitUser

        %% User Interaction: Delete Story
        WaitUser -->|Click #btndelete| DeleteStart[Confirm Delete]
        DeleteStart -->|Yes| DelReads[Read Story Data]
        DelReads --> DelLoc[Delete from Location JSON]
        DelLoc --> DelMaster[Delete from MasterIndex]
        DelMaster --> DelInst[Delete from Instructor JSON]
        DelInst --> DelOrg[Delete from Organisation JSON]
        DelOrg --> DelCat[Delete from Category Indices]
        DelCat --> DelFile[Delete Story Detail File]
        DelFile --> CloseWin[Close Window]

        %% User Interaction: Save Story
        WaitUser -->|Click #btnSave| Validate[Validate Form Data]
        Validate -->|Invalid| ShowError[Show Error Message]
        ShowError --> WaitUser
        Validate -->|Valid| CollectData[Collect Form Data & HTML]
        CollectData --> CheckSlugUnique{Slug Unique?}
        CheckSlugUnique -->|No| ShowError
        CheckSlugUnique -->|Yes| WriteFile[Write Story JSON to S3Path]

        %% Save Propagation Chain
        WriteFile --> UpdateTrending[WriteonTrendingNew: Update Top/Trending/Home Lists]
        UpdateTrending --> UpdateMaster[WriteInMasterIndex: Update Master Index]
        UpdateMaster --> CleanupCats[RemoveFromUnchecked: Remove from Old Categories]
        CleanupCats --> SaveInst[saveOninstructor: Update Instructor File]
        SaveInst --> SaveSub[saveOnSubcategory: Update Subcategory Files]
        SaveSub --> SaveLocTag[saveOnTags_Location: Update Location & Tag Files]
        SaveLocTag --> SaveMasterTag[saveTags_Master: Update Master Tags]
        SaveMasterTag --> CheckHide{Hidden?}
        CheckHide -->|Yes| HideLogic[HideFromAllJSON: Remove from public lists]
        CheckHide -->|No| CheckPriority{Priority?}
        CheckPriority -->|Yes| PrioLogic[MakeStoryPriority: Update Priority Order]
        CheckPriority -->|No| SaveOrg[saveOnOrganisation: Update Organisation File]
        HideLogic & PrioLogic --> SaveOrg
        SaveOrg --> Success[Show Success Message]
        Success --> WaitUser
    </div>
</body>

</html>